{% extends 'admin/admin_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}applicant-detail{% endblock %}

{% block css %}
<style>
  .applicant-detail .profile-pic {
    width: 150px;
    max-width: 100%;
    aspect-ratio: 1/1;
    object-fit: cover;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
  }
  .label {
    min-width: 180px;
    color: #6c757d;
  }
  .kv-row {
    display: flex;
    gap: 1rem;
    padding: 0.25rem 0;
  }
  .kv-row strong {
    min-width: 180px;
  }
  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .card img {
    height: 17rem;
    width: 17rem;
    object-fit: cover;
  }
</style>
{% endblock %}

{% block content %}

  <div class="applicant-detail">
    <div class="container mt-4">
      <h2 class="mb-4">Course Applicant Detail</h2>

      <!-- 1. Application Info -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between">
          <strong>Application Information</strong>
          <small class="opacity-75">Submitted {{ applicant.created_at|naturaltime }}</small>
        </div>
        <div class="card-body">
          <div class="kv-row"><strong class="label">Applicant</strong><div>{{ applicant.user.get_full_name|default:applicant.user.username }}</div></div>
          <div class="kv-row"><strong class="label">Email</strong><div>{{ applicant.user.email|default:"—" }}</div></div>
          <div class="kv-row"><strong class="label">Mobile No.</strong><div>{{ applicant.user.mobile }}</div></div>
          <div class="kv-row"><strong class="label">User Created at</strong><div>{{ applicant.user.user_created_at }}</div></div>
        </div>
      </div>

      <!-- 2. Personal Info -->
      {% if per_info %}
      <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
          <strong>Personal Information</strong>
        </div>
        <div class="card-body row g-4 align-items-start">
          <div class="col-md-8">
            <div class="kv-row"><strong class="label">Address</strong><div>{{ per_info.address|default:"—" }}</div></div>
            <div class="kv-row"><strong class="label">Gender</strong><div>{{ per_info.get_gender_display|default:"—" }}</div></div>
            <div class="kv-row"><strong class="label">Date of Birth</strong><div>{{ per_info.dob|date:"Y-m-d"|default:"—" }}</div></div>
            <div class="kv-row"><strong class="label">Father’s Name</strong><div>{{ per_info.father|default:"—" }}</div></div>
            <div class="kv-row"><strong class="label">Mother’s Name</strong><div>{{ per_info.mother|default:"—" }}</div></div>
            <div class="kv-row"><strong class="label">Grandfather’s Name</strong><div>{{ per_info.grandfather|default:"—" }}</div></div>
            <div class="kv-row"><strong class="label">Citizenship No.</strong><div>{{ per_info.citizenship_no|default:"—" }}</div></div>
          </div>
          <div class="col-md-4 text-md-end">
            {% if per_info.profile_pic %}
              <img src="{{ per_info.profile_pic.url }}" alt="Profile Pic" class="profile-pic" />
            {% else %}
              <img src="{% static 'images/profile_pic1.jpg' %}" alt="Default Profile" class="profile-pic" />
            {% endif %}
          </div>
        </div>
      </div>
      {% else %}
        <div class="alert alert-warning">No personal information available.</div>
      {% endif %}

      <!-- 3. Citizenship Document -->
      {% if per_info and per_info.ctz_file %}
      <div class="card mb-4" style="width: 18rem;">
        <div class="card-header bg-light">
          <strong>Citizenship Document</strong>
        </div>
        <img src="{{ per_info.ctz_file.url }}" class="card-img-top" alt="Citizenship Document" />
        <div class="card-body text-center">
          <a href="{{ per_info.ctz_file.url }}" target="_blank" class="btn btn-outline-primary btn-sm">View Full</a>
        </div>
      </div>
      {% endif %}

      <!-- 4. Educational Info -->
      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <strong>Educational Background</strong>
        </div>
        <div class="card-body">
          {% if edu_info %}
            <table class="table table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  <th>Level</th>
                  <th>Faculty</th>
                  <th>Course Name</th>
                  <th>University</th>
                  <th>College</th>
                  <th>Year</th>
                  <th>Grade/CGPA</th>
                </tr>
              </thead>
              <tbody>
                {% for edu in edu_info %}
                <tr>
                  <td>{{ edu.level|default:"—" }}</td>
                  <td>{{ edu.faculty|default:"—" }}</td>
                  <td>{{ edu.course_name|default:"—" }}</td>
                  <td>{{ edu.university_name|default:"—" }}</td>
                  <td>{{ edu.college_name|default:"—" }}</td>
                  <td>{{ edu.passed_year|default:"—" }}</td>
                  <td>{{ edu.grade_percent|default:"—" }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="alert alert-warning">No educational information available.</div>
          {% endif %}
        </div>
      </div>

      <!-- 5. Educational Documents -->
      {% for edu_docs in document_info %}
        <h5 class="mt-4">{{ edu_docs.edu.level }} - {{ edu_docs.edu.faculty }} ({{ edu_docs.edu.passed_year }})</h5>
        <div class="table-responsive mb-4">
          <table class="table table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Document Type</th>
                <th>Preview</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for label, file in edu_docs.documents %}
                <tr>
                  <td>{{ label }}</td>
                  <td>
                    {% if ".pdf" in file.url %}
                      <img src="{% static 'img/pdf-icon.png' %}" alt="PDF Icon" style="width: 60px;">
                    {% else %}
                      <img src="{{ file.url }}" alt="{{ label }}" style="max-height: 80px;">
                    {% endif %}
                  </td>
                  <td>
                    <a href="{{ file.url }}" target="_blank" class="btn btn-outline-primary btn-sm">Open</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>  
      {% endfor %}

          
 

      <!-- 6. Application Status -->
      {% if applicant %}
      <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
          <strong>Application Status</strong>
        </div>
        <div class="card-body">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Degree</th>
                <th>Course</th>
                <th>Application No.</th>
                <th>Submitted At</th>
                <th>Status</th>
                {% if applicant.application_status == 'approved' %}
                  <th>Approved Date</th>
                {% elif applicant.application_status == 'rejected' %}
                  <th>Rejection Reason</th>
                  <th>Rejection Date</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>{{ applicant.course.degree }}</td>
                <td>{{ applicant.course.course_name }}</td>
                <td>{{ applicant.application_no }}</td>
                <td>{{ applicant.submitted_at }}</td>
                <td class="{% if applicant.application_status == 'rejected' %}text-danger{% else %}text-success{% endif %}">
                  {{ applicant.application_status }}
                </td>
                {% if applicant.application_status == 'approved' %}
                  <td>{{ applicant.approved_rejected_date }}</td>
                {% elif applicant.application_status == 'rejected' %}
                  <td>{{ applicant.reason_to_reject }}</td>
                  <td>{{ applicant.approved_rejected_date }}</td>
                {% endif %}
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- 7. Payment Details -->
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <strong>Payment Details</strong>
        </div>
        {% if payment_info %}
        <div class="card-body">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Transaction ID</th>
                <th>Status</th>
                <th>Channel</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Paid Course</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>{{ payment_info.transaction_uuid }}</td>
                <td>{{ payment_info.status }}</td>
                <td>{{ payment_info.payment_method }}</td>
                <td>{{ payment_info.amount_paid }}</td>
                <td>{{ payment_info.payment_date }}</td>
                <td>{{ payment_info.application.course.course_name|default:"—" }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="card-body">
          <p>No payment has been recorded for this application.</p>
        </div>
        {% endif %}
      </div>

      <!-- 8. Action Buttons -->
      <div class="d-flex gap-3 justify-content-center py-4">
        <a href="{% url 'course_application_list' %}" class="btn btn-outline-secondary">← Back</a>
        {% if applicant.application_status == 'pending' or applicant.application_status == 're-submit' %}
        <form method="post" action="{% url 'approval_rejection' applicant.pk %}">
          {% csrf_token %}
          <button type="submit" name="action" value="approve" class="btn btn-success">Approve</button>
          <button type="submit" name="action" value="reject" class="btn btn-danger">Reject</button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}


