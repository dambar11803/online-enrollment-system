{% extends 'student/student_base.html' %}
{% load static %}

{% block title %}Personal Information{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/student/application_list.css' %}" />
{% endblock %}

{% block body %}
<div class="application-list-dashboard">
  {% if applications %}
    <div class="application-list-title text-start">My Application</div>
  {% endif %}

  {% for app in applications %}
  <table class="table-bordered">
    <thead class="bg-primary">
      <tr>
        <th>SN</th>
        <th>Application No</th>
        <th>Course</th>
        <th>Degree</th>
        <th>Duration</th>
        <th>Submitted at</th>
        <th>Status</th>
        {% if app.application_status == 'rejected' %}
          <th class="text-danger">Rejection Reason</th>
          <th class="text-danger">Rejection Date</th>
        {% elif app.application_status == 'approved' %}
          <th class="text-success">Approval Date</th>
        {% endif %}
      </tr>
    </thead>

    <tbody>
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ app.application_no }}</td>
        <td>{{ app.course.course_name }}</td>
        <td>{{ app.course.degree }}</td>
        <td>{{ app.course.course_duration }}</td>
        <td>{{ app.submitted_at|date:"Y-m-d H:i" }}</td>
        <td>{{ app.application_status|title }}</td>

        {% if app.application_status == 'rejected' %}
          <td>{{ app.reason_to_reject }}</td>
          <td>{{ app.approved_rejected_date|date:"Y-m-d H:i" }}</td>
        {% elif app.application_status == 'approved' %}
          <td class="text-success">{{ app.approved_rejected_date|date:"Y-m-d H:i" }}</td>
        {% endif %}
      </tr>
    </tbody>
  </table>

  <!--Payment Table if payment done-->
  <div class="payment-detail">
        <div class="card-header bg-success text-white">
          
        </div>
        {% if payment_info %}
        <div class="card-body">
          <table class="table-bordered">
            <thead class="bg-success">
              <tr>
                <th>Transaction ID</th>
                <th>Channel</th>
                <th>Amount</th>
                <th>Payment Status</th>
                <th>Payment Date</th>
                <th>Paid Course</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>{{ payment_info.transaction_uuid }}</td>
                <td>{{ payment_info.payment_method }}</td>
                <td>{{ payment_info.amount_paid }}</td>
                <td>{{ payment_info.status }}</td>
                <td>{{ payment_info.payment_date }}</td>
                <td>{{ payment_info.application.course.course_name|default:"â€”" }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="card-body">
            <div class="payment-methods text-center py-4">
              <a href="{% url 'esewa_initiate' app.pk %}" class="btn btn-success">
                Pay with eSewa
              </a>
              <a href="{% url 'khalti_initiate' app.pk %}" class="btn btn-outline-primary ms-2">
                Pay with Khalti
              </a>
          </div>
        </div>
        {% endif %}
      </div>


  {# -------- Re-submit Button (when rejected) -------- #}
  {% if app.application_status == 'rejected' %}
    <div class="text-end py-3">
      <a href="{% url 're_submit_application' app.pk %}" class="btn btn-outline-danger">
        Re-submit Application
      </a>
    </div>
  {% endif %}

  {% empty %}
    <div class="no-application-list text-center py-4">
      No course has been applied yet.
    </div>
  {% endfor %}
</div>
{% endblock %}
